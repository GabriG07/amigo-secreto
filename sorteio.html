<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sorteio - Amigo Secreto</title>
  <link rel="stylesheet" href="style2.css">
</head>
<body>
  <div class="container">
    <h1>Sorteio</h1>
    <p id="info">Aguarde o cadastro de todos os participantes antes de sortear.</p>
    <ul id="lista" class="participant-list"></ul>
    <button id="btnSortear">Realizar Sorteio</button>
    <button id="btnLimpar" class="danger-btn">Limpar Dados</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqdHnNCq_5ce2WaASz0-BriGO8ampNLvE",
      authDomain: "amigosecreto-bec0a.firebaseapp.com",
      projectId: "amigosecreto-bec0a",
      storageBucket: "amigosecreto-bec0a.appspot.com",
      messagingSenderId: "153625267113",
      appId: "1:153625267113:web:4c891417a0c7ad560652b8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const lista = document.getElementById("lista");
    const info = document.getElementById("info");
    const btnSortear = document.getElementById("btnSortear");
    const btnLimpar = document.getElementById("btnLimpar");

    async function carregarParticipantes() {
      lista.innerHTML = "";
      const snap = await getDocs(collection(db, "participantes"));
      if (snap.empty) {
        info.textContent = "Nenhum participante cadastrado.";
        return [];
      }
      const participantes = [];
      snap.forEach(doc => {
        const p = doc.data();
        participantes.push({ id: doc.id, nome: p.nome, avatar: p.avatar });
        const li = document.createElement("li");
        li.innerHTML = `<img src="${p.avatar}" alt=""><span>${p.nome}</span>`;
        lista.appendChild(li);
      });
      return participantes;
    }

    function gerarSorteio(participantes) {
      let sorteio = {};
      let disponiveis = [...participantes];
      for (let p of participantes) {
        let opcoes = disponiveis.filter(d => d.id !== p.id && sorteio[d.id] !== p.id);
        if (opcoes.length === 0) return null;
        let escolhido = opcoes[Math.floor(Math.random() * opcoes.length)];
        sorteio[p.id] = escolhido.id;
        disponiveis = disponiveis.filter(d => d.id !== escolhido.id);
      }
      return sorteio;
    }

    btnSortear.addEventListener("click", async () => {
      const participantes = await carregarParticipantes();
      if (participantes.length < 2) {
        alert("É necessário pelo menos 2 participantes para sortear.");
        return;
      }
      let resultado = gerarSorteio(participantes);
      let tentativas = 0;
      while (!resultado && tentativas < 50) {
        resultado = gerarSorteio(participantes);
        tentativas++;
      }
      if (!resultado) {
        alert("Erro ao gerar sorteio. Tente novamente.");
        return;
      }
      await setDoc(doc(db, "sorteio", "resultado"), resultado);
      alert("✅ Sorteio realizado com sucesso!");
    });

    btnLimpar.addEventListener("click", async () => {
      if (!confirm("⚠️ Deseja realmente apagar todos os dados?")) return;
      const snap = await getDocs(collection(db, "participantes"));
      for (const d of snap.docs) await deleteDoc(doc(db, "participantes", d.id));
      await deleteDoc(doc(db, "sorteio", "resultado"));
      lista.innerHTML = "";
      info.textContent = "Todos os dados foram apagados.";
    });

    carregarParticipantes();
  </script>
</body>
</html>
