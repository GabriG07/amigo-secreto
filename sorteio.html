<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorteio - Amigo Secreto</title>
  <link rel="stylesheet" href="style2.css">
</head>
<body>
  <div class="container">
    <h1>Painel do Sorteio</h1>
    <div id="info" style="margin-bottom:12px;color:#e6e8ee"></div>
    <div id="lista" class="participants-grid" style="margin-bottom:18px"></div>
    <button id="btnSortear" style="width:88%;max-width:420px">Realizar Sorteio</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqdHnNCq_5ce2WaASz0-BriGO8ampNLvE",
      authDomain: "amigosecreto-bec0a.firebaseapp.com",
      projectId: "amigosecreto-bec0a",
      storageBucket: "amigosecreto-bec0a.appspot.com",
      messagingSenderId: "153625267113",
      appId: "1:153625267113:web:4c891417a0c7ad560652b8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function carregarParticipantes() {
      const q = await getDocs(collection(db, "participantes"));
      const arr = [];
      q.forEach(s => {
        const data = s.data();
        arr.push({ id: s.id, nome: data.nome, senha: data.senha, avatar: data.avatar });
      });
      return arr;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function gerarPares(participantes) {
      if (participantes.length < 2) return null;
      const nomes = participantes.map(p => p.nome);
      const maxAttempts = 5000;
      let attempt = 0;
      while (attempt < maxAttempts) {
        attempt++;
        const recipients = [...nomes];
        shuffle(recipients);
        const mapping = {};
        let ok = true;
        for (let i = 0; i < nomes.length; i++) {
          if (nomes[i] === recipients[i]) { ok = false; break; }
          mapping[nomes[i]] = recipients[i];
        }
        if (!ok) continue;
        let mutual = false;
        for (const a of nomes) {
          const b = mapping[a];
          if (mapping[b] === a) { mutual = true; break; }
        }
        if (mutual) continue;
        return mapping;
      }
      return null;
    }

    function renderLista(participantes) {
      const lista = document.getElementById('lista');
      lista.innerHTML = '';
      participantes.forEach(p => {
        const div = document.createElement('div');
        div.className = 'participant';
        div.innerHTML = `<img src="${p.avatar}"><div class="participant-name">${p.nome}</div>`;
        lista.appendChild(div);
      });
    }

    document.getElementById('btnSortear').addEventListener('click', async () => {
      document.getElementById('info').textContent = 'Processando sorteio...';
      const participantes = await carregarParticipantes();
      if (participantes.length < 2) { document.getElementById('info').textContent = 'É necessário pelo menos 2 participantes.'; return; }
      const pares = gerarPares(participantes);
      if (!pares) { document.getElementById('info').textContent = 'Não foi possível gerar pares sem conflitos. Tente novamente.'; return; }
      await setDoc(doc(db, "sorteio", "resultado"), pares);
      document.getElementById('info').textContent = 'Sorteio realizado com sucesso!';
    });

    (async ()=> {
      const participantes = await carregarParticipantes();
      renderLista(participantes);
      if (participantes.length === 0) document.getElementById('info').textContent = 'Nenhum participante cadastrado.';
    })();
  </script>
</body>
</html>
