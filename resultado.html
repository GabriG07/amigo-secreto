<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Resultado - Amigo Secreto</title>
  <link rel="stylesheet" href="style2.css">
</head>
<body>
  <div class="container">
    <h1>Resultado</h1>
    <p id="info">Selecione seu perfil para ver quem vocÃª tirou ğŸ</p>
    <div id="participantes" class="avatar-grid"></div>
  </div>

  <div id="modalSenha" class="modal">
    <div class="modal-content">
      <img id="modalAvatar" src="" alt="">
      <h2 id="modalNome"></h2>
      <input type="password" id="inputSenha" placeholder="Digite sua senha">
      <button id="btnVer">Ver amigo secreto</button>
    </div>
  </div>

  <div id="modalResultado" class="modal">
    <div class="modal-content">
      <h2>VocÃª tirou:</h2>
      <img id="resultadoAvatar" src="" alt="">
      <h3 id="resultadoNome"></h3>
      <button id="btnFechar">Fechar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqdHnNCq_5ce2WaASz0-BriGO8ampNLvE",
      authDomain: "amigosecreto-bec0a.firebaseapp.com",
      projectId: "amigosecreto-bec0a",
      storageBucket: "amigosecreto-bec0a.appspot.com",
      messagingSenderId: "153625267113",
      appId: "1:153625267113:web:4c891417a0c7ad560652b8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const participantesDiv = document.getElementById("participantes");
    const modalSenha = document.getElementById("modalSenha");
    const modalAvatar = document.getElementById("modalAvatar");
    const modalNome = document.getElementById("modalNome");
    const inputSenha = document.getElementById("inputSenha");
    const btnVer = document.getElementById("btnVer");
    const modalResultado = document.getElementById("modalResultado");
    const resultadoAvatar = document.getElementById("resultadoAvatar");
    const resultadoNome = document.getElementById("resultadoNome");
    const btnFechar = document.getElementById("btnFechar");

    let participantes = [];
    let selecionado = null;

    async function carregarParticipantes() {
      const snap = await getDocs(collection(db, "participantes"));
      participantesDiv.innerHTML = "";
      participantes = [];
      snap.forEach(docSnap => {
        const p = docSnap.data();
        const el = document.createElement("div");
        el.className = "avatar-option";
        el.innerHTML = `<img src="${p.avatar}" alt=""><span>${p.nome}</span>`;
        el.onclick = () => abrirModalSenha(p, docSnap.id);
        participantesDiv.appendChild(el);
        participantes.push({ id: docSnap.id, ...p });
      });
    }

    function abrirModalSenha(p, id) {
      selecionado = { ...p, id };
      modalAvatar.src = p.avatar;
      modalNome.textContent = p.nome;
      inputSenha.value = "";
      modalSenha.style.display = "flex";
      inputSenha.focus();
    }

    btnVer.addEventListener("click", async () => {
      if (!selecionado) return;
      const senha = inputSenha.value.trim();
      if (senha !== selecionado.senha) {
        alert("Senha incorreta!");
        return;
      }
      const sorteioSnap = await getDoc(doc(db, "sorteio", "resultado"));
      if (!sorteioSnap.exists()) {
        alert("O sorteio ainda nÃ£o foi realizado.");
        return;
      }
      const resultado = sorteioSnap.data();
      const idSorteado = resultado[selecionado.id];
      const sorteado = participantes.find(p => p.id === idSorteado);
      if (!sorteado) {
        alert("NÃ£o foi possÃ­vel encontrar o resultado.");
        return;
      }
      modalSenha.style.display = "none";
      resultadoAvatar.src = sorteado.avatar;
      resultadoNome.textContent = sorteado.nome;
      modalResultado.style.display = "flex";
    });

    modalSenha.addEventListener("keydown", e => {
      if (e.key === "Enter") btnVer.click();
    });

    btnFechar.addEventListener("click", () => {
      modalResultado.style.display = "none";
    });

    window.addEventListener("click", e => {
      if (e.target === modalSenha) modalSenha.style.display = "none";
      if (e.target === modalResultado) modalResultado.style.display = "none";
    });

    carregarParticipantes();
  </script>
</body>
</html>
